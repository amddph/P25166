# Install required libraries
!pip install nrclex pandas openpyxl nltk

# Import libraries
from nrclex import NRCLex
import pandas as pd
import numpy as np
import nltk

# Download required NLTK resource
nltk.download('punkt_tab')

# Load Excel file (replace 'your_file.xlsx' with your actual file name)
file_path = '/content/ForGT_SirJeffFile.xlsx'  # Update this path
df = pd.read_excel(file_path)

# Assume the text data is in a column named 'Text' (update if different)
text_column = 'Comment'  # Change to your column name if needed

# Check if the column exists
if text_column not in df.columns:
    raise ValueError(f"Column '{text_column}' not found in the Excel file. Available columns: {df.columns}")

# Handle missing or non-string values in the text column
df[text_column] = df[text_column].fillna('').astype(str)

# Initialize lists to store emotion and sentiment scores
emotions = ['anger', 'fear', 'anticipation', 'trust', 'surprise', 'sadness', 'joy', 'disgust', 'positive', 'negative']
for emotion in emotions:
    df[emotion.capitalize()] = 0.0  # Initialize columns for each emotion

# Perform emotion analysis in batches
batch_size = 100
for i in range(0, len(df), batch_size):
    batch_texts = df[text_column][i:i + batch_size].tolist()
    # Process each text in the batch
    for idx, text in enumerate(batch_texts):
        # Skip empty strings, assign neutral scores (0.0)
        if not text.strip():
            continue
        # Create NRCLex object for the text
        emotion = NRCLex(text)
        # Get emotion frequencies
        affect_scores = emotion.affect_frequencies
        # Update DataFrame with scores for each emotion
        for emotion_key in emotions:
            df.iloc[i + idx, df.columns.get_loc(emotion_key.capitalize())] = affect_scores.get(emotion_key, 0.0)

# Display the first few rows of results
print("First few rows of results:")
print(df[[text_column] + [emotion.capitalize() for emotion in emotions]].head())

# Save results to a new Excel file
output_file = '/content/fortesting_nrclex.xlsx'
df.to_excel(output_file, index=False)
print(f"Results saved to {output_file}")

# Optional: Download the output file (uncomment if needed)
# from google.colab import files
# files.download(output_file)